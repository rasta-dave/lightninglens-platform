<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Test Client</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      #connection-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .connecting {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      button {
        padding: 8px 16px;
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background-color: #0069d9;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      pre {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
      }
      .controls {
        margin-bottom: 20px;
      }
      #messages {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
      }
      label {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Lightning Lens WebSocket Test Client</h1>
    <div id="connection-status" class="disconnected">Disconnected</div>

    <div class="controls">
      <label for="server-url">WebSocket Server URL:</label>
      <input
        type="text"
        id="server-url"
        value="ws://localhost:8767"
        style="width: 300px" />

      <button id="connect-btn">Connect</button>
      <button id="disconnect-btn" disabled>Disconnect</button>
      <button id="heartbeat-btn" disabled>Send Heartbeat</button>
      <button id="get-suggestions-btn" disabled>Get Suggestions</button>
    </div>

    <div>
      <input type="checkbox" id="prevent-auto-disconnect" checked />
      <label for="prevent-auto-disconnect">Prevent auto-disconnection</label>
    </div>

    <h3>Messages</h3>
    <div id="messages"></div>

    <script>
      // DOM elements
      const statusEl = document.getElementById('connection-status');
      const connectBtn = document.getElementById('connect-btn');
      const disconnectBtn = document.getElementById('disconnect-btn');
      const heartbeatBtn = document.getElementById('heartbeat-btn');
      const getSuggestionsBtn = document.getElementById('get-suggestions-btn');
      const serverUrlInput = document.getElementById('server-url');
      const messagesEl = document.getElementById('messages');
      const preventAutoDisconnectCheckbox = document.getElementById(
        'prevent-auto-disconnect'
      );

      // WebSocket connection
      let socket = null;
      let heartbeatInterval = null;

      // Update status display
      function updateStatus(status, message) {
        statusEl.className = status;
        statusEl.textContent = message;
      }

      // Log message to the messages div
      function logMessage(type, message, isError = false) {
        const now = new Date().toISOString();
        let formattedMessage = message;

        if (typeof message === 'object') {
          try {
            formattedMessage = JSON.stringify(message, null, 2);
          } catch (e) {
            formattedMessage = message.toString();
          }
        }

        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<strong>${now} - ${type}:</strong> <pre${
          isError ? ' style="color: red;"' : ''
        }>${formattedMessage}</pre>`;
        messagesEl.appendChild(logEntry);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      // Connect to WebSocket server
      function connect() {
        try {
          const url = serverUrlInput.value;
          updateStatus('connecting', 'Connecting...');

          socket = new WebSocket(url);

          socket.onopen = function (e) {
            updateStatus('connected', 'Connected');
            logMessage('System', 'Connection established');

            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
            heartbeatBtn.disabled = false;
            getSuggestionsBtn.disabled = false;

            // Start heartbeat interval if prevent auto-disconnect is checked
            if (preventAutoDisconnectCheckbox.checked) {
              heartbeatInterval = setInterval(() => {
                sendHeartbeat();
              }, 30000); // Send heartbeat every 30 seconds
            }
          };

          socket.onmessage = function (event) {
            try {
              const data = JSON.parse(event.data);
              logMessage('Received', data);
            } catch (e) {
              logMessage('Received (raw)', event.data);
            }
          };

          socket.onclose = function (event) {
            if (event.wasClean) {
              updateStatus(
                'disconnected',
                `Connection closed cleanly, code=${event.code}, reason=${event.reason}`
              );
              logMessage(
                'System',
                `Connection closed cleanly, code=${event.code}, reason=${event.reason}`
              );
            } else {
              // e.g. server process killed or network down
              updateStatus('error', 'Connection died');
              logMessage('System', `Connection died, code=${event.code}`, true);
            }

            // Clean up
            if (heartbeatInterval) {
              clearInterval(heartbeatInterval);
              heartbeatInterval = null;
            }

            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            heartbeatBtn.disabled = true;
            getSuggestionsBtn.disabled = true;
          };

          socket.onerror = function (error) {
            updateStatus('error', 'Connection error');
            logMessage('Error', error, true);
          };
        } catch (e) {
          updateStatus('error', 'Failed to connect');
          logMessage('Error', e.message, true);
        }
      }

      // Disconnect from WebSocket server
      function disconnect() {
        if (socket) {
          socket.close(1000, 'User requested disconnect');

          if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
          }
        }
      }

      // Send heartbeat message
      function sendHeartbeat() {
        if (socket && socket.readyState === WebSocket.OPEN) {
          const heartbeat = {
            type: 'heartbeat',
            timestamp: new Date().toISOString(),
          };

          socket.send(JSON.stringify(heartbeat));
          logMessage('Sent', heartbeat);
        }
      }

      // Request suggestions
      function getSuggestions() {
        if (socket && socket.readyState === WebSocket.OPEN) {
          const request = {
            type: 'get_suggestions',
            timestamp: new Date().toISOString(),
          };

          socket.send(JSON.stringify(request));
          logMessage('Sent', request);
        }
      }

      // Event listeners
      connectBtn.addEventListener('click', connect);
      disconnectBtn.addEventListener('click', disconnect);
      heartbeatBtn.addEventListener('click', sendHeartbeat);
      getSuggestionsBtn.addEventListener('click', getSuggestions);

      preventAutoDisconnectCheckbox.addEventListener('change', function () {
        if (socket && socket.readyState === WebSocket.OPEN) {
          if (this.checked) {
            // Start heartbeat interval
            if (!heartbeatInterval) {
              heartbeatInterval = setInterval(sendHeartbeat, 30000);
              logMessage('System', 'Auto-heartbeat enabled');
            }
          } else {
            // Stop heartbeat interval
            if (heartbeatInterval) {
              clearInterval(heartbeatInterval);
              heartbeatInterval = null;
              logMessage('System', 'Auto-heartbeat disabled');
            }
          }
        }
      });
    </script>
  </body>
</html>
